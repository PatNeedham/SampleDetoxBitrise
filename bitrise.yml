format_version: "5"
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git
project_type: react-native
trigger_map:
  - push_branch: "*"
    workflow: primary
  - pull_request_source_branch: "*"
    workflow: primary
workflows:
  deploy:
    steps:
      - activate-ssh-key@3.1.1:
          run_if: '{{getenv "SSH_RSA_PRIVATE_KEY" | ne ""}}'
      - git-clone@4.0.11: {}
      - script@1.1.5:
          title: Do anything with Script step
      - npm@0.9.1:
          inputs:
            - command: install
      - install-missing-android-tools@2.1.1: {}
      - android-build@0.9.4:
          inputs:
            - project_location: "$PROJECT_LOCATION"
            - module: "$MODULE"
            - variant: "$BUILD_VARIANT"
      - certificate-and-profile-installer@1.9.3: {}
      - xcode-archive@2.4.8:
          inputs:
            - project_path: "$BITRISE_PROJECT_PATH"
            - scheme: "$BITRISE_SCHEME"
            - export_method: "$BITRISE_EXPORT_METHOD"
            - configuration: Release
      - deploy-to-bitrise-io@1.3.12: {}
  primary:
    steps:
      - activate-ssh-key@3.1.1:
          run_if: '{{getenv "SSH_RSA_PRIVATE_KEY" | ne ""}}'
      - cache-pull@2.0.1: {}
      - git-clone@4.0.11: {}
      - script@1.1.5:
          title: Do anything with Script step
      - npm@0.9.1:
          inputs:
            - command: install
      - script@1.1.5:
          title: Pod Install
          inputs:
            - is_debug: "yes"
            - content: |-
                #!/usr/bin/env bash
                cd ios/
                pod install
                cd ../
      - script@1.1.5:
          inputs:
            - is_debug: "yes"
            - content: |-
                #!/usr/bin/env bash
                brew tap wix/brew
                brew install applesimutils
                npm install -g detox-cli
                detox clean-framework-cache && detox build-framework-cache
                detox build --configuration ios.sim.release
                detox test verbose --configuration ios.sim.release --cleanup
          title: detox E2E test
      - cache-push@2.0.5:
          is_always_run: true
          inputs:
            - ignore_check_on_paths: "~/Library/Developer/Xcode/DerivedData"
            - cache_paths: |-
                $BITRISE_CACHE_DIR
                node_modules
                ~/Library/Developer/Xcode/DerivedData
      - deploy-to-bitrise-io@1.3.12: {}
app:
  envs:
    - opts:
        is_expand: false
      PROJECT_LOCATION: android
    - opts:
        is_expand: false
      GRADLEW_PATH: android/gradlew
    - opts:
        is_expand: false
      MODULE: app
    - opts:
        is_expand: false
      BUILD_VARIANT: Debug
    - opts:
        is_expand: false
      BITRISE_PROJECT_PATH: ios/SampleDetoxBitrise.xcodeproj
    - opts:
        is_expand: false
      BITRISE_SCHEME: SampleDetoxBitrise
    - opts:
        is_expand: false
      BITRISE_EXPORT_METHOD: development
